<ag-grid-angular
		class="w-full"
		domLayout="autoHeight"
		[columnDefs]="columnDefinitions"
		[defaultColDef]="defaultColumnDefinition"
		[rowData]="tradesRowData()"
		[theme]="agGridTheme">
</ag-grid-angular>

<ng-template #symbolHeaderTemplate let-displayName>
	<div class="flex items-center gap-2">
		<i class="fas fa-coins opacity-70"></i>
		<span>{{ displayName }}</span>
	</div>
</ng-template>

<ng-template #actionsTemplate let-row="row">
	<div class="flex items-center justify-center">
		<p-button severity="help" rounded="true" icon="fas fa-up-right-from-square" size="small" (click)="openDetails(row)" />
	</div>
</ng-template>

<p-dialog
		[visible]="detailsVisible()"
		(visibleChange)="detailsVisible.set($event)"
		(onHide)="detailsVisible.set(false)"
		[modal]="true"
		[draggable]="false"
		[dismissableMask]="true"
		[breakpoints]="{ '1024px': '60vw', '768px': '80vw', '560px': '95vw' }"
		[style]="{ width: '64rem' }">

	<ng-template pTemplate="header">
		<div class="flex items-center gap-3">
			<span class="font-semibold text-lg">{{ selectedTrade()?.symbol }}</span>
			<p-tag [value]="selectedTrade()?.chain" severity="info"></p-tag>
			<p-tag [value]="selectedTrade()?.side" [severity]="selectedTrade()?.side === 'BUY' ? 'success' : 'warn'"></p-tag>
		</div>
	</ng-template>

	<p-tabs [value]="0">
		<p-tablist>
			<p-tab [value]="0">Overview</p-tab>
			<p-tab [value]="1">Analytics</p-tab>
			<p-tab [value]="2">Raw</p-tab>
		</p-tablist>

		<p-tabpanels>
			<!-- Overview -->
			<p-tabpanel [value]="0">
				<div class="grid grid-cols-12 gap-4 text-sm">
					<div class="col-span-12 md:col-span-6">
						<div class="opacity-70">Token</div>
						<div class="font-mono break-all flex items-center gap-2">
							{{ selectedTrade()?.tokenAddress }}
							<button pButton icon="far fa-copy" class="p-button-text p-button-sm" pTooltip="Copy token address"
							        (click)="copyToClipboard(selectedTrade()?.tokenAddress)"></button>
						</div>
					</div>

					<div class="col-span-12 md:col-span-6">
						<div class="opacity-70">Pair</div>
						<div class="font-mono break-all flex items-center gap-2">
							{{ selectedTrade()?.pairAddress }}
							<button pButton icon="far fa-copy" class="p-button-text p-button-sm" pTooltip="Copy pair address"
							        (click)="copyToClipboard(selectedTrade()?.pairAddress)"></button>
						</div>
					</div>

					<div class="col-span-4">
						<div class="opacity-70">Quantity</div>
						<div class="font-semibold">{{ formatNumber(selectedTrade()?.qty, 2, 6) }}</div>
					</div>
					<div class="col-span-4">
						<div class="opacity-70">Price</div>
						<div class="font-semibold">{{ formatCurrency(selectedTrade()?.price, 'USD', 4, 8) }}</div>
					</div>
					<div class="col-span-4">
						<div class="opacity-70">Order notional</div>
						<div class="font-semibold">{{ formatCurrency(orderNotionalUsd(selectedTrade()), 'USD', 2, 2) }}</div>
					</div>

					<div class="col-span-6">
						<div class="opacity-70">Date</div>
						<div class="font-semibold">{{ selectedTrade()?.created_at | date: 'yyyy-MM-dd HH:mm:ss' }}</div>
					</div>
					<div class="col-span-6">
						<div class="opacity-70">Status</div>
						<div class="font-semibold">{{ selectedTrade()?.status }}</div>
					</div>

					<p-divider class="col-span-12"></p-divider>

					<div class="col-span-12">
						<div class="opacity-70">Links</div>
						<div class="flex flex-wrap gap-2 mt-1">
							<a pButton label="Dexscreener (Pair)" icon="fas fa-arrow-up-right-from-square"
							   [href]="dexUrlForPair(selectedTrade())" target="_blank"></a>
							<a pButton label="Dexscreener (Token)" icon="fas fa-arrow-up-right-from-square"
							   [href]="dexUrlForToken(selectedTrade())" target="_blank"></a>
						</div>
					</div>
				</div>
			</p-tabpanel>

			<!-- Analytics with ApexCharts -->
			<p-tabpanel [value]="1">
				<div class="grid grid-cols-12 gap-4">
					<p-card class="col-span-12 md:col-span-6">
						<div class="opacity-70 text-xs mb-2">Scores</div>
						<apx-chart
								*ngIf="scoresSeries.length > 0"
								[series]="scoresSeries"
								[chart]="scoresChart"
								[labels]="scoresLabels"
								[plotOptions]="scoresPlot"
								[legend]="scoresLegend"
								[grid]="grid"
								[states]="states"
								[tooltip]="tooltip">
						</apx-chart>
						<div *ngIf="scoresSeries.length === 0" class="opacity-60 text-xs">No score available.</div>
					</p-card>

					<p-card class="col-span-12 md:col-span-6">
						<div class="opacity-70 text-xs mb-2">Î” (5m / 1h / 24h)</div>
						<apx-chart
								[series]="deltaSeries"
								[chart]="deltaChart"
								[xaxis]="deltaXaxis"
								[plotOptions]="deltaPlot"
								[colors]="deltaColors"
								[dataLabels]="deltaDataLabels"
								[grid]="grid"
								[states]="states"
								[tooltip]="tooltip">
						</apx-chart>
					</p-card>

					<p-card class="col-span-12 md:col-span-6">
						<div class="opacity-70 text-xs mb-2">Liquidity vs Volume (24h)</div>
						<apx-chart
								[series]="liqVolSeries"
								[chart]="liqVolChart"
								[labels]="liqVolLabels"
								[grid]="grid"
								[states]="states"
								[tooltip]="tooltip">
						</apx-chart>
					</p-card>

					<p-card class="col-span-12 md:col-span-6">
						<div class="opacity-70 text-xs mb-2">Order notional</div>
						<apx-chart
								[series]="notionalSeries"
								[chart]="notionalChart"
								[plotOptions]="notionalPlot"
								[xaxis]="notionalXaxis"
								[dataLabels]="notionalDataLabels"
								[grid]="grid"
								[states]="states"
								[tooltip]="tooltip">
						</apx-chart>
					</p-card>
				</div>
			</p-tabpanel>

			<!-- Raw -->
			<p-tabpanel [value]="2">
				<p-panel header="Show raw JSON (lazy)" [toggleable]="true">
					<p-scrollPanel [style]="{height: '24rem'}">
						<pre class="text-xs">{{ selectedTrade() | json }}</pre>
					</p-scrollPanel>
				</p-panel>
			</p-tabpanel>
		</p-tabpanels>
	</p-tabs>

	<ng-template pTemplate="footer">
		<div class="flex items-center justify-between w-full">
			<div class="opacity-60 text-xs">
				<i class="fas fa-circle-info mr-1"></i>Press <kbd>Esc</kbd> to close
			</div>
			<button pButton type="button" label="Close" class="p-button-text" (click)="detailsVisible.set(false)"></button>
		</div>
	</ng-template>
</p-dialog>
